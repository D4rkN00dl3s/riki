$(function () {
	// --- Konstantes / –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã ---
	const PEEP_ID = 11420468;
	const CHUNK = 10;
	const MAX_TRACKS = 50;

	// --- StƒÅvoklis / –°–æ—Å—Ç–æ—è–Ω–∏–µ ---
	const state = {
		mode: 'normal',            // 'normal' vai 'peep' / 'normal' –∏–ª–∏ 'peep'
		currentMood: null,         // pƒìdƒìjais izmantotais noska≈Üojums / –ø–æ—Å–ª–µ–¥–Ω–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –Ω–∞—Å—Ç—Ä–æ–π
		lists: { peep: [], normal: [] },
		indices: { peep: 0, normal: 0 },
		cache: {},                 // atska≈Üo≈°anas saraksti pƒìc noska≈Üojuma / –∫—ç—à –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤ –ø–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—é
		usedPlaylists: {}          // izmantotie atska≈Üo≈°anas saraksti, lai neb≈´tu atkƒÅrtojumu / –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–ª–µ–π–ª–∏—Å—Ç—ã, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–æ–≤
	};

	const moodKeywords = { happy: 'happy', sad: 'sad', chill: 'chill', energetic: 'energetic' };

	// --- Spineris / –°–ø–∏–Ω–Ω–µ—Ä ---
	function showSpinner() { $('#spinner').removeClass('hidden'); }
	function hideSpinner() { $('#spinner').addClass('hidden'); }

	// --- UI atiestatƒ´≈°ana / –°–±—Ä–æ—Å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ ---
	function resetView() {
		$('#tracks').empty();
		hideSpinner();
		$('#controls').toggle(state.mode === 'normal');
		$('#find-button').prop('disabled', false).text('Atrast m≈´ziku');
	}

	// --- ParƒÅdƒ´t nƒÅkamo daƒºu vai pƒÅrlƒÅdƒìt / –ü–æ–∫–∞–∑–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫ –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å ---
	function displayTracks() {
		const key = state.mode;
		const list = state.lists[key] || [];
		let idx = state.indices[key];

		// Nav vairƒÅk sarakstƒÅ vai sasniegts limits / –ù–µ—Ç –±–æ–ª—å—à–µ –≤ —Å–ø–∏—Å–∫–µ –∏–ª–∏ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç
		if (idx >= list.length || idx >= MAX_TRACKS) {
			if (state.mode === 'normal') {
				loadNormalTracks();
			} else {
				$('#find-button').text('No more').prop('disabled', true);
				hideSpinner();
			}
			return;
		}

		showSpinner();
		const end = Math.min(idx + CHUNK, list.length, MAX_TRACKS);
		list.slice(idx, end).forEach(tr => $('#tracks').append(createTrackDiv(tr)));
		state.indices[key] = end;
		hideSpinner();

		// Pogas teksta atjauninƒÅjums / –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∫–Ω–æ–ø–∫–∏
		if (state.indices[key] < list.length && state.indices[key] < MAX_TRACKS) {
			$('#find-button').text('Ieg≈´t vairƒÅk');
		} else {
			$('#find-button').text(state.mode === 'normal' ? 'Notƒ´rƒ´t' : 'No more');
		}
	}

	// --- IelƒÅdƒìt Lil Peep dziesmas / –ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–µ–∫–æ–≤ Lil Peep ---
	async function loadPeepTracks() {
		state.mode = 'peep'; resetView(); applyPeepStyle(); showSpinner();
		try {
			const data = await fetchPeepTracks();
			state.lists.peep = data.filter(tr => tr.preview && tr.artist.id === PEEP_ID);
			state.indices.peep = 0;
			$('#find-button').text('More');
			displayTracks();
		} catch (e) {
			console.error(e); alert('Kƒº≈´da ielƒÅdƒìjot Peep dziesmas / –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–µ–∫–æ–≤ Peep'); hideSpinner();
		}
	}

	// --- IelƒÅdƒìt dziesmas pƒìc noska≈Üojuma / –ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–µ–∫–æ–≤ –ø–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—é ---
	async function loadNormalTracks() {
		state.mode = 'normal'; resetView(); removePeepStyle(); showSpinner();
		try {
			const mood = $('#mood-select').val();
			// Ja mainƒÅs noska≈Üojums, atiestatƒ´t indeksu / –ü—Ä–∏ —Å–º–µ–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è —Å–±—Ä–æ—Å–∏—Ç—å –∏–Ω–¥–µ–∫—Å
			if (mood !== state.currentMood) {
				state.currentMood = mood;
				state.indices.normal = 0;
			}
			// Hopsƒìt vai izmantot ke≈°otu atska≈Ü. sarakstu / –ü–æ–ª—É—á–∏—Ç—å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–µ–π–ª–∏—Å—Ç
			if (!state.cache[mood]) {
				const pls = await searchPlaylists(moodKeywords[mood]);
				state.cache[mood] = Array.isArray(pls) ? pls : [];
			}
			// Nav pieejamu atska≈Üo≈°anas sarakstu? / –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤?
			if (state.cache[mood].length === 0) {
				alert('Neatrasti noska≈Üojuma pleilisti: ' + mood + ' / –ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è: ' + mood);
				hideSpinner();
				$('#find-button').text('No playlists').prop('disabled', true);
				return;
			}
			// Izvƒìlƒìties neizmantotu pleilisti / –í—ã–±—Ä–∞—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–æ–≤
			state.usedPlaylists[mood] = state.usedPlaylists[mood] || [];
			// Filtrƒìt izmantotos / –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ
			let available = state.cache[mood].filter(p => !state.usedPlaylists[mood].includes(p.id));
			// Ja visi izmantoti, atiestatƒ´t / –ï—Å–ª–∏ –≤—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã, —Å–±—Ä–æ—Å–∏—Ç—å —Å–ø–∏—Å–æ–∫
			if (available.length === 0) {
				state.usedPlaylists[mood] = [];
				available = state.cache[mood].slice();
			}
			const pl = pickRandom(available);
			// Atzƒ´mƒìt kƒÅ izmantotu / –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π
			state.usedPlaylists[mood].push(pl.id);
			// PƒÅrbaudƒ´t izvƒìlƒìto pleilisti / –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–ª–µ–π–ª–∏—Å—Ç
			if (!pl || !pl.id) {
				alert('Pleilista datu kƒº≈´da / –û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–ª–µ–π–ª–∏—Å—Ç–∞');
				hideSpinner();
				$('#find-button').text('Error').prop('disabled', true);
				return;
			}
			const data = await fetchPlaylistTracks(pl.id);
			state.lists.normal = Array.isArray(data) ? data.filter(t => t.preview) : [];
			state.indices.normal = 0;
			$('#find-button').text('More');
			// Ja pleilists tuk≈°s, auto atsvaidzinƒÅt / –ï—Å–ª–∏ –ø–ª–µ–π–ª–∏—Å—Ç –ø—É—Å—Ç, –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥—Ä—É–≥–æ–π
			if (state.lists.normal.length === 0) {
				alert('Pleilists tuk≈°s, tiek ielƒÅdƒìts cits... / –ü–ª–µ–π–ª–∏—Å—Ç –ø—É—Å—Ç, –∑–∞–≥—Ä—É–∂–∞—é –¥—Ä—É–≥–æ–π...');
				loadNormalTracks();
				return;
			}
			displayTracks();
		} catch (e) {
			console.error(e);
			alert('Kƒº≈´da ielƒÅdƒìjot m≈´ziku / –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º—É–∑—ã–∫–∏');
			hideSpinner();
		}
	}

	// --- Stila pƒÅrslƒìg≈°ana / –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∏–ª—è ---
	function applyPeepStyle() {
		$('#controls-container').hide();
		$('h1').text('üéµ Peep Mode');
		$('#peep-toggle').text('Exit Peep');
		$('body').addClass('peep-mode');
	}

	function removePeepStyle() {
		$('#controls-container').show();
		$('h1').text('üéß Moodify');
		$('#peep-toggle').text('Peep Mode');
		$('body').removeClass('peep-mode');
	}

	// --- Deezer JSONP pieprasƒ´jumi / Deezer JSONP –∑–∞–ø—Ä–æ—Å—ã ---
	function fetchPeepTracks() {
		return new Promise((res, rej) => {
			$.ajax({
				url: `https://api.deezer.com/artist/${PEEP_ID}/top?limit=100&output=jsonp`, dataType: 'jsonp',
				success: d => res(d.data || []), error: rej
			});
		});
	}
	function searchPlaylists(q) {
		return new Promise((res, rej) => {
			$.ajax({
				url: `https://api.deezer.com/search/playlist?q=${encodeURIComponent(q)}&output=jsonp`, dataType: 'jsonp',
				success: d => res(d.data || []), error: rej
			});
		});
	}
	function fetchPlaylistTracks(id) {
		return new Promise((res, rej) => {
			$.ajax({
				url: `https://api.deezer.com/playlist/${id}?output=jsonp`, dataType: 'jsonp',
				success: d => {
					const arr = d?.tracks?.data || [];
					res(Array.isArray(arr) ? arr : []);
				}, error: rej
			});
		});
	}

	// --- Palƒ´gfunkcijas un atska≈ÜotƒÅjs / –£—Ç–∏–ª–∏—Ç—ã –∏ –ø–ª–µ–µ—Ä ---
	function pickRandom(a) { return a[Math.floor(Math.random() * a.length)]; }

	let currentTrackDiv = null;
	const player = $('#global-player');
	const audio = player.find('audio')[0];
	const btnPlay = player.find('.play');
	const btnPrev = player.find('.prev');
	const btnNext = player.find('.next');
	const bar = player.find('.bar');
	const time = player.find('.time');
	const vol = player.find('.volume')[0];

	function createTrackDiv(tr) {
		const div = $('<div>').addClass('track').data('track', tr);
		$('<img>').attr('src', tr.album.cover_medium).attr('loading', 'lazy').appendTo(div);

		const info = $('<div>').addClass('track-info').appendTo(div);
		const yt = encodeURIComponent(`${tr.title} ${tr.artist.name}`);
		$('<p>').html(`<strong><a href="https://www.youtube.com/results?search_query=${yt}" target="_blank">${tr.title}</a></strong>`).appendTo(info);

		const sp = encodeURIComponent(tr.artist.name);
		$('<p>').html(`<a href="https://open.spotify.com/search/${sp}" target="_blank">${tr.artist.name}</a>`).appendTo(info);

		div.on('click', (e) => {
			if ($(e.target).is('a')) return;
			playTrack(tr, div);
		});

		return div;
	}

	function playTrack(track, trackDiv) {
		if (audio.src !== track.preview) {
			audio.src = track.preview;
		}

		currentTrackDiv?.removeClass('playing');
		currentTrackDiv = trackDiv;
		currentTrackDiv.addClass('playing');

		audio.play();

		$('.now-playing').text(`${track.title} ‚Äî ${track.artist.name}`);
	}

	btnPlay.on('click', () => {
		audio.paused ? audio.play() : audio.pause();
	});

	btnPrev.on('click', () => {
		if (!currentTrackDiv) return;
		const prev = currentTrackDiv.prev('.track');
		if (prev.length) playTrack(prev.data('track'), prev);
	});

	btnNext.on('click', () => {
		if (!currentTrackDiv) return;
		const next = currentTrackDiv.next('.track');
		if (next.length) playTrack(next.data('track'), next);
	});

	// Volume
	vol.oninput = () => {
		audio.volume = vol.value;
		localStorage.setItem('volume', vol.value);
	};

	const savedVolume = localStorage.getItem('volume');
	if (savedVolume !== null) {
		vol.value = savedVolume;
		audio.volume = savedVolume;
	}

	// Progress click
	player.find('.progress').on('click', e => {
		const r = player.find('.progress')[0].getBoundingClientRect();
		audio.currentTime = ((e.clientX - r.left) / r.width) * audio.duration;
	});

	// Time and UI update
	audio.ontimeupdate = () => {
		if (!audio.duration) return;
		const pct = (audio.currentTime / audio.duration) * 100;
		bar.css('width', pct + '%');
		const m = Math.floor(audio.currentTime / 60), s = String(Math.floor(audio.currentTime % 60)).padStart(2, '0');
		time.text(`${m}:${s}`);
	};

	audio.onplay = () => {
		$('audio').not(audio).each((i, a) => a.pause()); // just in case
		btnPlay.text('‚è∏Ô∏è');
	};

	audio.onpause = () => {
		btnPlay.text('‚ñ∂Ô∏è');
	};

	audio.onended = () => {
		const next = currentTrackDiv?.next('.track');
		if (next.length) {
			playTrack(next.data('track'), next);
		}
	};

	// --- Notikumu saistƒ´≈°ana / –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π ---
	if (localStorage.getItem('theme') === 'dark') {
		$('body').addClass('dark');
	}
	$('#theme-toggle').on('click', () => {
		$('body').toggleClass('dark');
		localStorage.setItem('theme', $('body').hasClass('dark') ? 'dark' : 'light');
	});

	$('#peep-toggle').on('click', () => state.mode === 'peep' ? loadNormalTracks() : loadPeepTracks());

	$('#find-button').on('click', () => {
		// NormƒÅlajƒÅ re≈æƒ´mƒÅ izlemt, vai ielƒÅdƒìt jaunus dziesmas vai parƒÅdƒ´t nƒÅkamo daƒºu / –í –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ —Ä–µ—à–∏—Ç—å, –∑–∞–≥—Ä—É–∂–∞—Ç—å –ª–∏ –Ω–æ–≤—ã–µ —Ç—Ä–µ–∫–∏ –∏–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫
		if (state.mode === 'normal') {
			const sel = $('#mood-select').val();
			// Ja dziesmas nav ielƒÅdƒìtas, noska≈Üojums mainƒ´ts vai viss parƒÅdƒ´ts, ielƒÅdƒìt jaunu / –ï—Å–ª–∏ —Ç—Ä–µ–∫–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–º–µ–Ω–∏–ª–æ—Å—å –∏–ª–∏ –≤—Å—ë –ø–æ–∫–∞–∑–∞–Ω–æ, –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–π –Ω–∞–±–æ—Ä
			if (
				state.lists.normal.length === 0 ||
				sel !== state.currentMood ||
				state.indices.normal >= state.lists.normal.length ||
				state.indices.normal >= MAX_TRACKS
			) {
				loadNormalTracks();
				return;
			}
		}
		// PretƒìjƒÅ gadƒ´jumƒÅ vienkƒÅr≈°i parƒÅdƒ´t nƒÅkamo daƒºu / –í –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫
		displayTracks();
	});
});

